INSTALLATION NOTES
==================
ETD requires that fedora-commons be configured as follows:
   - RIsearch enabled, with sync updates turned on
   - xacml enforcement enabled and combining algorithm set to ordered, permit overrides 
   (set XACML-COMBINING-ALGORITHM to com.sun.xacml.combine.OrderedPermitOverridesPolicyAlg
   in fedora.fcfg)
 - etd repository-wide policies (in src/fedora-policies) should be
   included in xacml policies, and default policy to allow all API-A
   should be disabled.  Recommended: check this out of svn and replace
   default fedora xacml policies https://svn.library.emory.edu/svn/fedora/repository-policies/  
 - Fedora 3.x requires a patch to allow cmodel xacml filtering
 - working LDAP authentication filter
 - custom ESD DeptData filter
 - Generic Search Service installed; use index script src/public/xslt/etdFoxmlToSolr.xslt
   - Solr instance, with schema from src/scripts/solr-schema.xml
 - ETD control objects (cmodel/sdef/sdep) loaded 

Site webroot should be pointed at src/public
 - requires apache override, mod_rewrite
 - copy src/htaccess-sample to public/.htaccess and edit
 - edit config files in src/config 
    - copy *.xml.example to *.xml and edit
    - which section of the config file is loaded depends on mode
      setting in environment.xml

UPGRADE NOTES
=================

Version 1.9
-----------
* Make the appropriate host, port and user / pass changes to point to the fedora 3.4 instance
    - fedora.xml
    - solr.xml

* switch the fedora-policies to the branch https://svn.library.emory.edu/svn/fedora/repository-policies/branches/release_1.1

* Load control objects from https://svn.library.emory.edu/svn/fedora/control-objects/
    - AuthorInformation.xml
    - Collection.xml
    - ETD.xml
    - ETDformattedMetadataParts_XHTML_sdep.xml
    - ETDmetadataParts_sdef.xml
    - EtdFile.xml
    - Hierarchy.xml
    - MetadataTransform_ETD_sdep.xml
    - MetadataTransform_sdef.xml
    - OAI-Identify.xml


* Copy files from fedora 3.2 to fedora 3.4 and convert datastreams to managed
    - cd src/scripts
    - php ./console.php

    - Run these commands to create a list of pids to copy and convert:
    $ri = $fedora->risearch;
    file_put_contents("/tmp/ETD.txt", implode("\n",  $ri->findByCModel("emory-control:ETD-1.0")));
    file_put_contents("/tmp/ETDFile.txt", implode("\n",  $ri->findByCModel("emory-control:EtdFile-1.0")));
    file_put_contents("/tmp/ETDAuthorInfo.txt", implode("\n",  $ri->findByCModel("emory-control:AuthorInformation-1.0")));

    - cd /tmp
    - cat ETD.txt  ETDFile.txt ETDAuthorInfo.txt  > ETDPids.txt

   - Copy pids listed in ETDPids.txt to fedora3.4

   - Run the inline to managed conversion script on pids listed in ETDPids.tex in fedora 3.4
   Make sure the environment variables are set if avaliable this script will 
   set them to the correct value ". /home/fedora34/set-env-for-this-fedora.sh"

    /home/fedora34/server/bin/fedora-modify-control-group.sh
    migratedatastreamcontrolgroup https fedoraAdmin <password>
    file:////tmp/ETDPids.txt RELS-EXT,MODS,MADS,DC,XHTML,POLICY,PREMIS M >
    managedConversion.log      - you many have to use http for the 2nd param

   - Make sure to copy over These addition pids as well but do
     not run the managed migration on them:
     emory-control:ETD-collection
     emory-control:ETD-GradSchool-collection
    emory-control:ETD-College-collection
    emory-control:ETD-Candler-collection
    emory-control:ETD-Rollins-collection
    emory:17r1x

* Install ESDFilter on tomcat
    See Documentation/README-ESDFilter
 


* Update the ETD content model services for particular fedora instance.
    (1) emory-control:ETD-metadataTransform/datastreams/WSDL/content
    (2) emory-control::ETDformattedMetadataParts/datastreams/WSDL/content
    <wsdl:port binding="this:FedoraSaxon_http" name="FedoraSaxon_port">
    <http:address location="localhost:8080/saxon/"/>
    </wsdl:port>
    If the location parameter is not the default location adjust accordingly.
    

* Update GSearch with latest version of src/public/xslt/etdFoxmlToSolr.xslt
  and reindex all content.  Note that the xslt now requires a parameter
  containing the Fedora base url to be set in REPOSITORYURL.  You must edit
  this parameter if Fedora should be accessed somewhere other than this default:
        http://localhost:8080/fedora/ .  It looks like at least for the staging
        environment, the hostname will not work. You must use localhost.
     
*  Run the checksum script to determine the current checksum status.
   cd src/scripts
   ./update_checksum.php -v info
   Run the checksum script to perform any checksum updates to FILE datastreams.
   (this will take some time and should be run overnight)
   cd src/scripts
   ./update_checksum.php -v info -u       


Version 1.8.5
-------------
* Using the new reindex.php script that can be used to update the GSearch index
  for all ETD content requires updating config/fedora.xml
  with the gsearch index and repository name; see fedora.xml.example.

Version 1.8.3
-------------
* Run the migration scripts to add two new programs the emory college school: 
    - 018-add-programs.php
    
Version 1.8.1
-------------
* Edit the programs collection (emory:17r1x) and delete the last version of the SKOS datastream.
* Run the migration scripts to reload the rollins school data: 
    - 015-add-rollins-programs.php
    - 016-add_prog_codes_to_skos.php
* Delete all the records from etd_admins in the etd database
* Reload the data by running DB/002-load_init_data.php

Version 1.8
-----------
* Update fedora policies under FEDORA_HOME to new branch and restart Fedora:
   - staging: https://svn.library.emory.edu/svn/fedora/repository-policies/branches/etd_1.8.x
   - production: https://svn.library.emory.edu/svn/fedora/repository-policies/tags/etd_1.8
* Add etdOwner to config
* Remove honors_collection section from config.xml
* Remove collections section from config.xml
* Add etd-db.xml as specified in etd-db.xml.example file
* Run the following migrations / scripts
* 015a-add-collection_program_owners.php - Change maintenance_account to use fedoraAdmin for this migration then change back to etdmaint
   -  create_collections.php
   -  015-add-rollins-programs.php
   -  016-add-prog_codes_to_skos.php - before running this script, 
       manually edit the config.xml defined programs_pid.
       Select the SKOS datastream for edit, then add this attribute to first line:
       xmlns:dc="http://purl.org/dc/elements/1.1/"
   - DB/001-create_db_user_table.sql - See notes at top of script. You have to replace <DB NAME> and <PASSWORD> values.  Run this thru PHPMyAdmin
   - DB/002-load_init_data.php


Version 1.7
-----------
* main config.xml has new  sections for for news_feed and doc_feed
* persis.xml test section has changed
* Run following migrations:
   - 014-remove_duplicate_collection_membership.php
* Run a “forced refresh” on the fedora OAI provider


Version 1.6
-----------
* Changes to main config file (see config.xml.example)
   - make sure contact email name field is now required (reply-to for emails)
   - new report viewer department should be set
   - honors admin section is no longer needed, and should be removed
* Run the following migration scripts:
   - 012-add-candler-programs.php - update program hierarchy for Candler
   - 013-update_dc - Update the Dublin Core for all ETDs using the latest MODS -> DC conversion
* Publication script has changed; weekly cron job that runs
   publish.php should be revised to send the output to a log file.
* solr schema and indexing has changed, both should be updated:
   - restart solr (etd solr schema should be a symlink to copy in etd svn)
   - re-index all fedora objects with Fedora GSearch
* update fedora xacml policies from latest svn


Version 1.5
-----------
* latest version of ETD cmodel & new service objects must be loaded to Fedora
* update fedora xacml policies from latest svn
* run migration 011
* update gsearch & solr to latest xslt index & solr schema, reindex
* recommended: configure gsearch to include etd xslt to simplify
   future updates, use symlink for solr schema
* config/fedora.xml now requires pidspace for running tests
* if connecting to fedora as localhost, add alternate hostnames to
   config/fedora.xml (new html service will only respond to requests
   from configured fedora instance)

Version 1.4
-----------
* run migrations 006-010
* update gsearch & solr to latest xslt index & solr schema, reindex


Version 1.2
-----------
* run migration: 005-add_program_ids.php 
* update gsearch & solr to latest xslt index & solr schema, reindex

Version 1.0
-----------
* run update_rights_statement.php, clean_xacml.php after updating


Version 0.9.5
-------------
* update gsearch & solr to latest xslt index & solr schema


Version 0.9.4
-------------
* install ESD Fedora filter for graduate program coordinator permissions
* run clean_xacml script to fix/update xacml on all etd records
* update gsearch to latest solr schema & index xslt
* set path for logfile in config.xml; needs to be readable and writable by apache
